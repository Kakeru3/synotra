# Synotra言語 構文仕様書（実装版）

> 本仕様書は、現在のパーサー・AST・セマンティック解析の実装に基づいて記述されています。

---

## 1. アクターの定義とメッセージング

アクターモデルを言語のプリミティブとして扱い、宣言的に定義します。

### アクター定義

| 項目 | 構文例 | 説明 |
| :--- | :--- | :--- |
| **アクター定義** | `actor UserSession(id: Int) { ... }` | `actor` キーワードで、独立した並列実行体（アクター）を定義します。コンストラクタパラメータで初期状態を受け取れます。 |
| **アクターメンバー** | フィールドまたはメソッド | アクター内部にフィールド（状態）とメソッド（関数）を定義できます。 |

### メッセージ定義

| 項目 | 構文例 | 説明 |
| :--- | :--- | :--- |
| **データメッセージ** | `data message Task(val id: Int, val description: String)` | アクター間でやり取りされるメッセージを定義します。すべてのフィールドは不変（`val`）でなければなりません。 |

### メッセージ通信

| 項目 | 構文例 | 説明 |
| :--- | :--- | :--- |
| **メッセージ送信（非同期）** | `worker.send(Task(101, "Process data"))` | **Fire-and-Forget**。結果を待たずにメッセージを非同期送信します。 |
| **メッセージ送信（同期）** | `worker.ask(Task(104, "Urgent task"))` | **Askパターン**。応答を待機します。ランタイムが非同期性を完全に抽象化するため、`await` は不要です。 |
| **アクター生成** | `var worker = spawn(Worker, 1)` | 新しいアクターインスタンスを生成します。第1引数はアクター型、その後にコンストラクタ引数を渡します。 |

### メッセージハンドラー

| 項目 | 構文例 | 説明 |
| :--- | :--- | :--- |
| **受信ハンドラー** | `io fun receive(task: Task) { ... }` | 特定のメッセージ型を受け取る関数。通常はI/O関数として定義します。 |
| **任意のハンドラー** | `io fun handle(req: Request) { ... }` | `receive`以外の名前も使用可能。メッセージ型のパラメータを持つ関数として動作します。 |

---

## 2. 状態管理（変数定義）

### 不変参照と可変状態

| 構文例 | 説明 | 特性 |
| :--- | :--- | :--- |
| `val x = 10` | **不変な参照**。初期値設定後、変更不可。 | 最も安全。型推論が可能。 |
| `val x: Int` | **型指定の不変参照**（初期値なし）。後で一度だけ代入可能。 | 型を明示的に指定する場合。 |
| `var count = 0` | **可変な状態**。再代入可能。 | アクター内部でのみ変更可能（Single Writer原則）。 |
| `var y: Int` | **型指定の可変変数**（初期値なし）。後で代入・再代入可能。 | 使用前に必ず代入が必要（definite assignment分析）。 |

### アクターフィールド

アクター内部で状態を保持する場合、フィールドとして定義します（現在の実装では明示的なフィールド定義構文は確認できていませんが、AST上はサポート）。

---

## 3. ファイル操作と副作用の明記

ファイル操作やネットワークI/Oなど、副作用のある操作を行う関数には`io`キーワードを付けます。

| 構文例 | 説明 | 実行コンテキスト |
| :--- | :--- | :--- |
| `io fun run() { ... }` | ファイル操作や標準出力などのI/O操作を行う関数。`io` キーワード必須。 | ランタイムは非同期I/Oスレッドプールで実行。 |
| `io fun printLog(msg: String) { ... }` | I/O関数は戻り値の型を持たない（暗黙的に`Unit`型）。 | 同上。 |
| `fun calculate(a: Int): Int { ... }` | **純粋な計算処理**。副作用を持たない。戻り値の型指定が必須。 | 並列実行可能なタスクとして扱われる可能性。 |

### I/O関数と純粋関数の違い

- **I/O関数**: `io fun`で定義、戻り値型なし（`println`などの副作用のある操作）
- **純粋関数**: `fun`で定義、戻り値型必須（`return`で値を返す）

---

## 4. 制御フロー

### 条件分岐

| 構文例 | 説明 |
| :--- | :--- |
| `if (x > 5) { ... }` | 条件が真の場合に実行。 |
| `if (x > 5) { ... } else { ... }` | else節を含む条件分岐。 |

### ループ

| 構文例 | 説明 |
| :--- | :--- |
| `while (count < 10) { ... }` | 条件が真の間、繰り返し実行。 |
| `for (i in 0..5) { ... }` | 範囲ベースのforループ。`0`から`4`まで（終端値は含まない）。 |
| `for (item in collection) { ... }` | コレクションの各要素に対して繰り返し（forEach構文）。 |

---

## 5. 関数定義

### 純粋関数

| 構文例 | 説明 |
| :--- | :--- |
| `fun add(a: Int, b: Int): Int { return a + b }` | 副作用のない純粋な計算。戻り値型必須。 |

### I/O関数

| 構文例 | 説明 |
| :--- | :--- |
| `io fun printResult(x: Int) { println(x) }` | 副作用を持つ関数。戻り値型なし。 |

---

## 6. 型システム

### 基本型

| 型 | 説明 | 例 |
| :--- | :--- | :--- |
| `Int` | 整数型 | `42`, `0`, `-10` |
| `String` | 文字列型 | `"Hello"`, `"World"` |
| `Bool` | 真偽値型 | `true`, `false` |
| `Unit` | 値なし（I/O関数の戻り値） | - |

### 複合型

| 型 | 説明 | 例 |
| :--- | :--- | :--- |
| `ActorRef<T>` | アクター参照型 | `ActorRef<Worker>` |
| `UserDefined` | ユーザー定義型（データメッセージなど） | `Task`, `User` |
| `Generic<T>` | ジェネリック型 | `List<Int>`, `Map<String, Int>` |

---

## 7. 式と演算子

### リテラル

| リテラル | 例 |
| :--- | :--- |
| 整数 | `42`, `0`, `-10` |
| 文字列 | `"Hello, World!"` |
| 真偽値 | `true`, `false` |

### 二項演算子

| 演算子 | 説明 | 例 |
| :--- | :--- | :--- |
| `+` | 加算（数値）、連結（文字列） | `5 + 3`, `"Hello " + "World"` |
| `-` | 減算 | `10 - 3` |
| `*` | 乗算 | `4 * 7` |
| `/` | 除算 | `20 / 4` |
| `==` | 等価比較 | `x == 5` |
| `!=` | 非等価比較 | `x != 0` |
| `<`, `<=`, `>`, `>=` | 大小比較 | `x > 5`, `y <= 10` |

### その他の式

| 構文 | 説明 | 例 |
| :--- | :--- | :--- |
| フィールドアクセス | データメッセージのフィールドにアクセス | `user.name`, `task.id` |
| 関数呼び出し | 関数やメソッドを呼び出す | `add(5, 3)`, `worker.send(msg)` |
| インデックスアクセス | コレクションの要素にアクセス | `list[0]` |
| コンストラクタ | データメッセージを構築 | `User(1, "Alice")` |

---

## 8. 文字列補間

文字列内で`${}`を使って変数や式の値を埋め込めます。

```synotra
var name = "Alice"
var age = 30
println("Name: ${name}, Age: ${age}")
println("Sum: ${5 + 3}")
```

---

## 9. コメント

| 構文 | 説明 |
| :--- | :--- |
| `// コメント` | 行コメント。`//`から行末まで |

---

## 10. プログラム構造

すべてのSynotraプログラムは、少なくとも以下の構造を持ちます：

```synotra
actor main(name: String) {
    io fun run() {
        // プログラムのエントリーポイント
        println("Hello, World!")
    }
}
```

- `main`アクターが必須
- `run()`関数がエントリーポイント
- `run()`は必ず`io fun`として定義

---

## 未実装の機能

以下の機能はASTに定義されていますが、現在は実装されていません：

- **CRDTサポート**: `crdt var`構文、CRDT型
- **モジュールシステム**: `module`キーワード、モジュール定義
- **IO変数**: `io val`構文（変数へのI/Oマーク）
- **通常のメッセージ**: `message`キーワード（`data message`のみ実装）
